<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Stok Barang ‚Äì AJAX Google Sheet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/id.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/833/833314.png" />
  <style>
    .status-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .5rem;border-radius:9999px;font-weight:600}
    .status-aman{background:#e7f8ef}
    .status-waspada{background:#fff6e6}
    .status-bahaya{background:#ffeaea}
    .dt-img-name{display:flex;align-items:center;gap:0.75rem}
    .dt-img-name img {
      width: 40px; 
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      background: #f0f0f0;
    }
    .time-ago-badge {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 8px;
      border-radius: 9999px;
      background-color: #e0f2fe;
      color: #0c4a6e;
      font-size: 0.75rem;
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div class="max-w-6xl mx-auto p-6">
  <header class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">üì¶ Laporan Stok Barang</h1>
      <p id="last-updated" class="text-sm text-slate-500">Memuat data‚Ä¶</p>
    </div>
    <div class="flex items-center gap-2">
      <select id="statusFilter" class="border rounded-lg px-3 py-2 bg-white text-sm">
        <option value="">Semua Status</option>
        <option value="Aman">üü¢ Aman</option>
        <option value="Waspada">üü° Waspada</option>
        <option value="Bahaya">üî¥ Bahaya</option>
      </select>
      <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm">‚Üª Muat Ulang</button>
    </div>
  </header>

  <section class="grid md:grid-cols-3 gap-4 mb-6">
    <div class="rounded-2xl bg-white shadow p-4">
      <div class="text-xs text-slate-500">Total Item</div>
      <div id="statTotal" class="text-2xl font-bold">-</div>
    </div>
    <div class="rounded-2xl bg-white shadow p-4">
      <div class="text-xs text-slate-500">Item Aman</div>
      <div id="statAman" class="text-2xl font-bold">-</div>
    </div>
    <div class="rounded-2xl bg-white shadow p-4">
      <div class="text-xs text-slate-500">Perlu Perhatian (Waspada/Bahaya)</div>
      <div id="statAlert" class="text-2xl font-bold">-</div>
    </div>
  </section>
  
  <div id="server-update-time" class="text-center text-sm text-slate-600 mb-6" style="display: none;">
    Memuat waktu update data...
  </div>

  <section class="grid md:grid-cols-3 gap-6 mb-8">
    <div class="md:col-span-2 rounded-2xl bg-white shadow p-4">
      <table id="stokTable" class="display w-full"></table>
    </div>
    <div class="rounded-2xl bg-white shadow p-4">
      <h3 class="font-semibold mb-3">Ringkasan Status</h3>
      <canvas id="ringkasanChart" height="260"></canvas>
      <hr class="my-4" />
      <h3 class="font-semibold mb-2">Preview Pesan WhatsApp</h3>
      <textarea id="waPreview" class="w-full h-48 border rounded-lg p-3 text-sm" readonly></textarea>
      <div class="flex gap-2 mt-2">
        <button id="copyBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm">Salin Pesan</button>
        <button id="regenBtn" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm">Buat Ulang</button>
      </div>
    </div>
  </section>

  <footer class="text-center text-xs text-slate-500">by Ramadnintya ‚Ä¢ Data via Google Apps Script x Spreadsheet</footer>
<footer class="text-center text-xs text-slate-500">
V.2.1.1 Final Version</footer>
</div>

<script>
// ================== KONFIGURASI ==================
// URL AJAX diperbarui
const API_URL = "https://script.google.com/macros/s/AKfycbxyJ0B9lP5ersRXtwyYobNI0FYfGGGpiDSL7-t1uYIavSKTc2ZWqMh_OBLbJ-IvX-VTGw/exec";

// PERUBAHAN 1: Menambahkan ID unit kustom (PAC1, PAC2) ke RULES
const RULES = {
  // ID Kustom (PAC1): Rentang Khusus
  "PAC1": { unit: "pack", aman: 5, waspada: 3, bahaya: 1 }, 
  
  // ID Kustom (PAC2): Rentang Khusus Lain
  "PAC2": { unit: "pack", aman: 10, waspada: 5, bahaya: 2 },
  
  // ID Generik
  "PAC": { unit: "pack", aman: 2, waspada: 1, bahaya: 0 },
  "KNT": { unit: "kantong", aman: 2, waspada: 1, bahaya: 0 },
  "ML": { unit: "ml", aman: 200, waspada: 90, bahaya: 30 },
  "SHT": { unit: "sheets", aman: 80, waspada: 40, bahaya: 30 },
  "PCS": { unit: "pcs", aman: 30, waspada: 20, bahaya: 10 }
}

function parseQty(str){
  if (!str) return {qty:0, unit:"", id:""}
  let parts = str.toString().trim().split(" ")
  
  let qty = 0;
  let unit = "";
  let id = "";
  
  // Cari ID yang cocok di awal string (misalnya PAC1 5 pack)
  const idMatch = Object.keys(RULES).find(key => str.startsWith(key + " "));
  
  if (idMatch) {
    id = idMatch;
    // Hapus ID dan spasi dari string sebelum di-parse
    const qtyUnitStr = str.substring(id.length + 1).trim();
    const qtyUnitParts = qtyUnitStr.split(" ");
    qty = parseInt(qtyUnitParts[0]) || 0;
    unit = qtyUnitParts.slice(1).join(" ").toLowerCase();
  } else if (parts.length >= 2) {
    // Format Qty Unit (e.g., 5 pack)
    qty = parseInt(parts[0]) || 0;
    unit = parts.slice(1).join(" ").toLowerCase();
    // Coba temukan ID generik berdasarkan unit
    for (const [key, value] of Object.entries(RULES)) {
      if (value.unit === unit && key.length <= 3) { // Hanya ambil ID generik 3 huruf (PAC, KNT, dll)
        id = key;
        break;
      }
    }
  }

  return {qty, unit, id: id || unit} // Kembalikan ID yang ditemukan atau unit sebagai fallback
}

function statusOf(qty, unitOrId){
  // Gunakan ID atau Unit sebagai kunci pencarian di RULES
  let r = RULES[unitOrId] || Object.values(RULES).find(rule => rule.unit === unitOrId);
  if (!r) return {label:"-", icon:"‚ùì", cls:"", priority: 3} // Prioritas 3: Tidak Tahu
  if (qty <= r.bahaya) return {label:"Bahaya", icon:"üî¥", cls:"status-bahaya", priority: 0} // Prioritas 0: Bahaya (tertinggi)
  if (qty <= r.waspada) return {label:"Waspada", icon:"üü°", cls:"status-waspada", priority: 1} // Prioritas 1: Waspada
  return {label:"Aman", icon:"üü¢", cls:"status-aman", priority: 2} // Prioritas 2: Aman (terendah)
}

// Fungsi bantu untuk status tahu goreng (menggunakan warna solid seperti di screenshot)
function getColorByStatus(num, currentTahu) {
    // Logika sederhana: jika angka pola ada (num > 0), gunakan warna biru/merah
    if (num > 0) return "#3498db"; // Biru untuk data yang ada (48, 49)
    return "#e74c3c"; // Merah untuk data yang tidak ada (-)
}

let dt, chart

async function loadData(){
  $('#refreshBtn').prop('disabled', true).text("Memuat...");
  document.getElementById('last-updated').textContent = "Menghubungi server...";
  const serverTimeDiv = document.getElementById('server-update-time');
  serverTimeDiv.style.display = 'block';
  serverTimeDiv.textContent = 'Memuat waktu update data...';
  
  try{
    const response = await fetch(API_URL,{cache:"no-store"});
    if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const result = await response.json(); 

    const raw = result.data;
    const lastUpdatedFromServer = result.lastUpdated;
    
    // Asumsi data gorengan diambil dari key 'gorengan'
    const gorengData = result.gorengan || {
        "Gorengan Tahu Ini": "1 Goreng",
        "Target Goreng": "4 Goreng",
        "Pola Goreng": "48, 49"
    };

    if (!raw || raw.length===0) throw new Error("Data dari server kosong atau tidak valid.");

    const rows = raw.map(r=>{
      const tersedia = r.Tersedia || "";
      const { qty, unit, id } = parseQty(tersedia);
      // Gunakan ID yang ditemukan atau unit sebagai fallback
      const st = statusOf(qty, id);
      return {
        gambar: r.Gambar || "",
        barang: r.Barang || r.Nama || "Barang",
        tersedia: tersedia,
        statusObj: st,
        statusPriority: st.priority // Tambahkan untuk sorting WA
      }
    });
    
    // PERUBAHAN STATUS TAHU GORENG (sesuai format baru)
    const currentTahuStr = gorengData["Gorengan Tahu Ini"] || "0 Goreng";
    const targetTahuStr = gorengData["Target Goreng"] || "0 Goreng";
    const polaGorengStr = gorengData["Pola Goreng"] || "";
    
    // Ambil angka saja
    const currentTahu = parseInt(currentTahuStr.split(" ")[0]) || 0;
    const targetTahu = parseInt(targetTahuStr.split(" ")[0]) || 0;
    
    // Pola Goreng diubah jadi array of numbers
    const polaGoreng = polaGorengStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
    
    // Buat array target sesuai jumlah targetTahu (4 elemen) dan tambahkan 0/'-' jika kurang
    const targetArray = Array(targetTahu).fill(0).map((_, i) => polaGoreng[i] || 0);

    const tahuStatusText = `Status Target Tahu: ${currentTahu} / ${targetTahu} Goreng (Pola: ${polaGorengStr || '-'})`;
    
    // Tampilan persis seperti screenshot
    let tahuStatusHTML = `<h3 class="font-bold text-center text-xl mt-2 mb-4">Status Target Tahu: ${currentTahu} / ${targetTahu} Goreng</h3>`;
    
    const polaHTML = targetArray.map((num) => {
        const displayNum = num === 0 ? '-' : num;
        const bgColor = getColorByStatus(num, currentTahu);

        return `<span style="display:inline-block; margin-right: 8px; padding: 6px 16px; border-radius: 6px; background-color: ${bgColor}; color: white; font-weight: bold; font-size: 1.1rem;">${displayNum}</span>`;
    }).join('');
    
    tahuStatusHTML += `<div class="mt-2 flex justify-center">${polaHTML}</div>`;
    // =========================================================================

    document.getElementById('last-updated').textContent = "Dimuat: " + dayjs().format("dddd, D MMM YYYY HH:mm");
    
    dayjs.extend(window.dayjs_plugin_relativeTime);
    dayjs.locale('id');
    const absoluteTime = dayjs(lastUpdatedFromServer).format("dddd, D MMMM YYYY HH:mm");
    const relativeTime = dayjs(lastUpdatedFromServer).fromNow();
    
    // PERUBAHAN 2b: Tampilkan Status Goreng
    serverTimeDiv.innerHTML = `<strong>Data diupdate pada:</strong> ${absoluteTime} <span class="time-ago-badge">${relativeTime}</span><div class="mt-3 p-3 bg-white border rounded-lg">${tahuStatusHTML}</div>`;


    const columns = [
      {
        title: "Barang",
        data: null,
        render: function(_, __, row) {
          return `<div class="dt-img-name">
                      <img src="${row.gambar}" alt="Gambar Barang">
                      <span>${row.barang}</span>
                  </div>`;
        }
      },
      { title: "Stok", data: "tersedia", width: "100px" },
      {
        title: "Status",
        data: 'statusObj.label',
        width: "120px",
        render: function(data, type, row) {
          return `<span class="status-badge ${row.statusObj.cls}">${row.statusObj.icon} ${row.statusObj.label}</span>`;
        }
      }
    ];

    if(dt){
      dt.clear(); dt.rows.add(rows).draw();
    } else {
      dt = new DataTable("#stokTable",{
        data:rows,
        columns,
        pageLength:10,
        language:{url:"https://cdn.datatables.net/plug-ins/2.0.8/i18n/id.json"}
      });

      $("#statusFilter").on("change",function(){
        const v = this.value;
        dt.column(2).search(v).draw();
      });
    }

    const total = rows.length;
    const aman = rows.filter(r => r.statusObj.label === "Aman").length;
    const waspada = rows.filter(r => r.statusObj.label === "Waspada").length;
    const bahaya = rows.filter(r => r.statusObj.label === "Bahaya").length;
    document.getElementById("statTotal").textContent = total;
    document.getElementById("statAman").textContent = aman;
    document.getElementById("statAlert").textContent = waspada+bahaya;

    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("ringkasanChart"),{
      type:"doughnut",
      data:{labels:["Aman","Waspada","Bahaya"],datasets:[{data:[aman,waspada,bahaya],backgroundColor:["#27ae60","#f1c40f","#e74c3c"]}]},
      options:{plugins:{legend:{position:"bottom"}}}
    });

    regeneratePreview(rows, tahuStatusText); 

  }catch(err){
    console.error(err);
    document.getElementById('last-updated').textContent = "Gagal memuat data.";
    serverTimeDiv.textContent = 'Gagal memuat waktu update data.';
    alert("Terjadi kesalahan: " + err.message);
  }finally{
    $('#refreshBtn').prop('disabled', false).text("‚Üª Muat Ulang");
  }
}

// PERUBAHAN 3: Urutan Pesan WhatsApp (Bahaya ke Aman)
function regeneratePreview(rows, tahuStatusText = ""){
  const now = dayjs().locale("id");
  const header = `üì¢ ${now.format("dddd")} - ${now.format("D MMMM YYYY, HH:mm")}\nLaporan Stok Kali Ini:`;
  
  // Urutkan item: Bahaya (0) -> Waspada (1) -> Aman (2) -> Tidak Tahu (3)
  const sortedRows = rows.sort((a, b) => a.statusPriority - b.statusPriority);

  let adaPeringatan = false;
  const lines = sortedRows.map((r,i)=>{
    if(r.statusObj.label!=="Aman") adaPeringatan=true;
    return `${i+1}. ${r.barang} => ${r.tersedia} | ${r.statusObj.icon} ${r.statusObj.label}`;
  });
  
  const tahuLine = tahuStatusText ? `\n\n--- Status Tambahan ---\n${tahuStatusText}` : "";
  const footer = adaPeringatan ? "‚ö†Ô∏è Mohon cek stok yang menipis." : "‚úÖ Semua stok aman, selamat menjalani usaha!";
  
  document.getElementById("waPreview").value = [header, tahuLine, "", ...lines, "", footer, "Info: https://ramadani1t.github.io/DB-Stock-Bot-Reminder"].join("\n");
}

// Events
$("#refreshBtn").on("click",loadData);
// Tombol regen sekarang memanggil loadData() agar status tahu juga di-refresh
$("#regenBtn").on("click",()=>{if(dt) loadData();}); 
$("#copyBtn").on("click",()=>{
  const el=document.getElementById("waPreview");
  el.select();
  document.execCommand("copy");
  const btn=document.getElementById("copyBtn");
  btn.textContent="‚úÖ Disalin";
  setTimeout(()=>btn.textContent="Salin Pesan",1500);
});

loadData();
</script>
</body>
</html>
