<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Monitoring Stok Barang</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .status-aman { color: green; font-weight: bold; }
    .status-waspada { color: orange; font-weight: bold; }
    .status-bahaya { color: red; font-weight: bold; }
    .toolbar { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>📊 Monitoring Stok Barang</h2>
  <div class="toolbar">
    <button id="reload">🔄 Muat Ulang</button>
    <label for="filterStatus">📋 Filter Status:</label>
    <select id="filterStatus">
      <option value="">Semua</option>
      <option value="Aman">✅ Aman</option>
      <option value="Waspada">⚠️ Waspada</option>
      <option value="Bahaya">⛔ Bahaya</option>
    </select>
  </div>
  <table id="stockTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Barang</th>
        <th>Tersedia</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbxh2pc5CNzRfVMcT0Cnya7E6jPYNLljTKjxy4a3WqivlKIA3uyIkf5PRy-G4IY9Qg-_fg/exec";

    function getStatus(value, unit) {
      let num = parseFloat(value);
      let status = "Aman";
      if (unit === "pack") {
        if (num <= 0) status = "Bahaya";
        else if (num === 1) status = "Waspada";
      } else if (unit === "Kantong") {
        if (num <= 0) status = "Bahaya";
        else if (num === 1) status = "Waspada";
      } else if (unit === "ml") {
        if (num <= 30) status = "Bahaya";
        else if (num <= 90) status = "Waspada";
      } else if (unit === "Sheets") {
        if (num <= 30) status = "Bahaya";
        else if (num <= 40) status = "Waspada";
      } else if (unit === "pcs") {
        if (num <= 10) status = "Bahaya";
        else if (num <= 20) status = "Waspada";
      }
      return status;
    }

    function getStatusClass(status) {
      if (status === "Bahaya") return "status-bahaya";
      if (status === "Waspada") return "status-waspada";
      return "status-aman";
    }

    let table;

    function loadData() {
      $.getJSON(url, function(data) {
        if (!Array.isArray(data)) {
          console.error("Data bukan array:", data);
          return;
        }
        let rows = data.map(item => {
          if (!item.Tersedia) return null;
          let parts = item.Tersedia.split(" ");
          let num = parseFloat(parts[0]);
          let unit = parts.slice(1).join(" ");
          let status = getStatus(num, unit);
          return [
            item.Nama || "-",
            item.Tersedia,
            `<span class="${getStatusClass(status)}">${status}</span>`
          ];
        }).filter(r => r !== null);

        table.clear().rows.add(rows).draw();
      });
    }

    $(document).ready(function() {
      table = $('#stockTable').DataTable({
        data: [],
        columns: [
          { title: "Barang" },
          { title: "Tersedia" },
          { title: "Status" }
        ]
      });

      loadData();

      $('#reload').on('click', function() {
        loadData();
      });

      $('#filterStatus').on('change', function() {
        let val = $(this).val();
        table.column(2).search(val).draw();
      });
    });
  </script>
</body>
</html>
